# https://itnext.io/on-premise-ha-kubernetes-cluster-15e41f18bd12
# https://octetz.com/posts/ha-control-plane-k8s-kubeadm


#####TEST
- name: TEST
  debug:
    msg: "{{main_master}}"


########################### main master ###############################

# First create token on main master
- name: Create join token on main master
  shell: |
    kubeadm token create \
      --ttl 10h \
      --description ansible_join_token_{{lookup('pipe','date +%Y%m%d%H%M%S')}} \
      --print-join-command
  register: kubeadm_token_create_result
  when: inventory_hostname == main_master


# Upload certs on main master
- name: Upload certs on main master
  shell: |
    kubeadm init phase upload-certs \
      --upload-certs | grep -v upload-certs
  register: kubeadm_init_phase_result
  when: inventory_hostname == main_master
  

########################### master-ha ###############################

# cluster config
- name: Create kubeadm config path
  file:
    path: "{{k8s_kubeadm_config_path}}"
    state: directory
    owner: "{{k8s_user}}"
    group: "{{k8s_user}}"
    mode: 0755
  when: inventory_hostname != main_master

- name: Copy custom kubeadm-config.yml
  template:
    src: kubeadm-config.yml.j2
    dest: "{{k8s_kubeadm_config_path}}/kubeadm-config.yml"
  when: inventory_hostname != main_master


# vars
- name: Register vars on HA masters
  set_fact:
    # master_join_command: "{{ hostvars[groups['master-initial'][0]]['kubeadm_token_create_result'].stdout }}"
    # master_upload_certs: "{{ hostvars[groups['master-initial'][0]]['kubeadm_init_phase_result'].stdout }}"
    master_join_command: "{{ hostvars[main_master]['kubeadm_token_create_result'].stdout }}"
    master_upload_certs: "{{ hostvars[main_master]['kubeadm_init_phase_result'].stdout }}"
  when: inventory_hostname != main_master

- name: Debug vars on HA masters
  debug:
    msg:
      - "master_join_command: {{master_join_command}}"
      - "master_upload_certs: {{master_upload_certs}}"
  when: inventory_hostname != main_master


# full join command
- name: Register HA master join command
  set_fact:
    full_join_command: |
      {{master_join_command}} --certificate-key {{master_upload_certs}} --control-plane --v={{k8s_api_debug_level}}
  when: inventory_hostname != main_master

- name: Debug master join command
  debug:
    msg: "{{full_join_command}}"
  when: inventory_hostname != main_master


# join master to cluster
# - name: Pull kubeadm images beforehand
#   shell: kubeadm config images pull
#   when: inventory_hostname != main_master

- name: Join HA masters to the cluster
  shell: |
    {{full_join_command}} >> master_node_joined.txt
  args:
    executable: /bin/bash
    chdir: "/home/{{k8s_user}}/"
    creates: master_node_joined.txt
  when: inventory_hostname != main_master


# copy init conf
- name: Create .kube directory
  file:
    path: "/home/{{k8s_user}}/.kube"
    state: directory
    owner: "{{k8s_user}}"
    group: "{{k8s_user}}"
    mode: 0755
  when: inventory_hostname != main_master

- name: Copy admin.conf to .kube folder
  copy:
    src: /etc/kubernetes/admin.conf
    dest: "/home/{{k8s_user}}/.kube/config"
    owner: "{{k8s_user}}"
    group: "{{k8s_user}}"
    remote_src: yes
  when: inventory_hostname != main_master
