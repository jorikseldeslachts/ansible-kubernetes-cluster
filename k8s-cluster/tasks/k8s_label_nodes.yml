# labeling for all nodes is done through a master

# Remove old role labels
- name: Remove master & worker labels from all nodes
  become_user: "{{k8s_user}}"
  shell: "kubectl label node {{item.0}} {{item.1}}-"
  with_nested: 
    - "{{hostvars}}"
    - [
      "node-role.kubernetes.io/master", 
      "node-role.kubernetes.io/worker"
      ]
  when: inventory_hostname in groups['master-initial']


# Set new role labels
- name: Set master label on masters
  become_user: "{{k8s_user}}"
  shell: "kubectl label node {{item}} node-role.kubernetes.io/master=master"
  with_nested: 
    - "{{ groups['masters'] }}"
  when: inventory_hostname in groups['master-initial']
  

- name: Set worker label on workers
  become_user: "{{k8s_user}}"
  shell: "kubectl label node {{item}} node-role.kubernetes.io/worker=worker"
  with_items: 
    - "{{groups['workers']}}"
  when: inventory_hostname in groups['master-initial']


# Debug current labels
- name: Get all labels on each node
  become_user: "{{k8s_user}}"
  shell: |
    kubectl get node {{item.0}} \
      -o custom-columns=LABELHEADER:.metadata.labels | grep -v LABELHEADER
  with_items: 
    - "{{hostvars}}"
  register: node_labels
  when: inventory_hostname in groups['master-initial']

- name: Debug node labels
  debug:
    msg: "{{node_labels}}"


